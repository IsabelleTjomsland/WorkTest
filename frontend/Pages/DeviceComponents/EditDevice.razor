@page "/edit-device"
@inject HttpClient Http
@inject NavigationManager Navigation

<h3>Edit Device</h3>

@if (device == null)
{
    <p>Loading...</p>
}
else
{
    <div class="mt-4">
        <div class="mb-3">
            <label for="deviceName">Name:</label>
            <input id="deviceName" type="text" @bind="device.Name" class="form-control" />
        </div>

        <div class="mb-3">
            <label for="deviceStatus">Status:</label>
            <div class="form-check form-switch">
                <input type="checkbox" id="deviceStatus" @bind="device.Status" class="form-check-input" />
            </div>
        </div>

        <button class="btn btn-primary mt-3" @onclick="SaveChanges">Save</button>
        <button class="btn btn-secondary mt-3" @onclick="Cancel">Cancel</button>
    </div>
}

@code {
    /// <summary>
    /// The device being edited.
    /// </summary>
    private Device device = new();

    /// <summary>
    /// This method is called when the component is initialized.
    /// It fetches the device details based on the ID passed in the query string.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var idString = query.Get("id");

        if (int.TryParse(idString, out int deviceId))
        {
            try
            {
                // Fetch the device details from the API
                device = await Http.GetFromJsonAsync<Device>($"http://localhost:5246/api/devices/{deviceId}");
            }
            catch (Exception ex)
            {
                // Log any errors that occur during fetching the device
                Console.WriteLine($"Error fetching device: {ex.Message}");
            }
        }
    }

    /// <summary>
    /// Saves the changes made to the device and navigates back to the device management page.
    /// </summary>
    private async Task SaveChanges()
    {
        try
        {
            // Update the device in the API
            await Http.PutAsJsonAsync($"http://localhost:5246/api/devices/{device.Id}", device);
            Navigation.NavigateTo("/devices-management");
        }
        catch (Exception ex)
        {
            // Log any errors during the update process
            Console.WriteLine($"Error updating device: {ex.Message}");
        }
    }

    /// <summary>
    /// Cancels the editing process and navigates back to the device management page.
    /// </summary>
    private void Cancel()
    {
        Navigation.NavigateTo("/devices-management");
    }

    /// <summary>
    /// Represents a device with an ID, Name, and Status.
    /// </summary>
    public class Device
    {
        /// <summary>
        /// The unique identifier of the device.
        /// </summary>
        public int Id { get; set; }

        /// <summary>
        /// The name of the device.
        /// </summary>
        public string Name { get; set; }

        /// <summary>
        /// The status of the device (true if the device is on, false if it is off).
        /// </summary>
        public bool Status { get; set; }
    }
}
